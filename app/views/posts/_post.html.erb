<article id="<%= dom_id(post) %>"
         class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-md border border-gray-100 p-8 mb-10 transition-all duration-300 hover:shadow-lg"
         data-controller="collapse">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
    <div class="flex-1">
      <h2 class="text-2xl sm:text-3xl font-semibold text-blue-700 hover:underline break-words">
        <%= link_to post.title, post_path(post) %>
      </h2>
      <p class="text-sm sm:text-base text-gray-500 mt-2">
        by <%= post.user&.name.presence || "Unknown" %> · <%= time_ago_in_words(post.created_at) %> ago
      </p>
    </div>

    <% if user_signed_in? && post.user == current_user %>
      <div class="flex flex-row space-x-3 shrink-0">
        <%= link_to "Edit", edit_post_path(post), class: "text-sm sm:text-base text-blue-600 hover:underline" %>
        <%= link_to "Delete", post, data: { turbo_method: :delete, turbo_confirm: "Sicher löschen?" }, class: "text-sm sm:text-base text-red-600 hover:underline" %>
      </div>
    <% end %>
  </div>

  <!-- Body -->
  <div class="mt-4 text-gray-700 text-base sm:text-lg leading-relaxed line-clamp-4">
    <%= simple_format(truncate(post.body, length: 400)) %>
  </div>

  <!-- Toggle Button -->
  <div class="mt-5">
    <button type="button"
            class="flex items-center space-x-1 text-blue-600 hover:text-blue-800 transition"
            data-action="collapse#toggle"
            aria-expanded="false"
            aria-controls="comments_<%= post.id %>">
      <span data-collapse-target="label" class="font-medium">
        Comments (<%= post.comments.where(parent_id: nil).count %>)
      </span>
      <svg data-collapse-target="chevron"
           class="w-4 h-4 transition-transform duration-200"
           viewBox="0 0 20 20"
           fill="currentColor"
           aria-hidden="true">
        <path fill-rule="evenodd"
              d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
      </svg>
    </button>
  </div>

  <!-- Collapsible Comments -->
  <div id="comments_<%= post.id %>"
       class="hidden mt-5 space-y-5"
       data-collapse-target="panel"
       aria-hidden="true">
    <% roots = post.comments.where(parent_id: nil).order(:created_at) %>
    <% if roots.any? %>
      <% roots.each do |comment| %>
        <div class="border-t border-gray-200 pt-3">
          <p class="text-gray-800 text-base sm:text-lg leading-relaxed"><%= comment.body %></p>
          <p class="text-sm text-gray-500 mt-1">
            — <%= comment.user&.name.presence || "Anonymous" %>, <%= time_ago_in_words(comment.created_at) %> ago
          </p>
        </div>
      <% end %>
    <% else %>
      <p class="text-gray-400 italic text-center py-3">No comments yet.</p>
    <% end %>
  </div>
</article>
